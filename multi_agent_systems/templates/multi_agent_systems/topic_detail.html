{% extends "base.html" %}
{% load static %}

{% block title %}{{ topic.topic_name|title }} Deep-Dive - Fed Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/topic_detail.css' %}">
{% endblock %}

{% block content %}
<div class="topic-detail-container animate-fade-in">
    <!-- Header -->
    <header class="topic-detail-header">
        <div class="header-main-group">
            <a href="{% url 'multi_agent_systems:topic_analysis_detail' uuid=topic.group.uuid %}" class="back-link"
                title="Back to Overview">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6" />
                </svg>
            </a>
            <h1 class="topic-page-title">{{ topic.topic_name|title }} Deep-Dive</h1>
        </div>
        <div
            class="sentiment-marker {% if topic.sentiment|lower == 'hawkish' %}hawk-marker{% elif topic.sentiment|lower == 'dovish' %}dove-marker{% else %}neutral-marker{% endif %}">
            {{ topic.sentiment }}
        </div>
    </header>

    <!-- Single Column Layout -->
    <div class="topic-content-flow">
        <!-- Executive Summary -->
        <section class="topic-section executive-summary-section">
            <div class="summary-lead">
                {{ topic.summary_text|linebreaks }}
            </div>
            {% if topic.summary_citations.all %}
            <details class="sources-toggle">
                <summary class="sources-label">View Sources ({{ topic.summary_citations.count }})</summary>
                <div class="sources-list">
                    {% for citation in topic.summary_citations.all %}
                    {% for source in citation.sources.all %}
                    <div class="source-item">
                        <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                        <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                            <span class="source-title">{{ source.article_source }}</span>
                            {% if source.article_url %}
                            <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                class="full-article-link">Full Article →</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </section>

        <!-- Sectoral Metrics (Horizontal, like Expert Analysis) -->
        <section class="topic-section collapsible-section">
            <button class="stance-header" onclick="toggleSection(this)">
                <h3 class="section-title">Sectoral
                    Metrics ({{ total_metrics_count }})</h3>
                <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="m6 9 6 6 6-6" />
                </svg>
            </button>
            <div class="stance-content">

                {% if hawkish_metrics %}
                <div class="stance-group hawk collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Hawkish Metrics ({{ hawkish_metrics|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="metric-list">
                            {% for metric in hawkish_metrics %}
                            <div class="metric-card card">
                                <div class="metric-header">
                                    <span class="metric-name">{{ metric.name }}</span>
                                </div>
                                <div class="metric-discussion">
                                    {{ metric.discussion|linebreaks }}
                                </div>
                                {% if metric.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ metric.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in metric.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if neutral_metrics %}
                <div class="stance-group neutral collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Neutral Metrics ({{ neutral_metrics|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="metric-list">
                            {% for metric in neutral_metrics %}
                            <div class="metric-card card">
                                <div class="metric-header">
                                    <span class="metric-name">{{ metric.name }}</span>
                                </div>
                                <div class="metric-discussion">
                                    {{ metric.discussion|linebreaks }}
                                </div>
                                {% if metric.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ metric.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in metric.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if dovish_metrics %}
                <div class="stance-group dove collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Dovish Metrics ({{ dovish_metrics|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="metric-list">
                            {% for metric in dovish_metrics %}
                            <div class="metric-card card">
                                <div class="metric-header">
                                    <span class="metric-name">{{ metric.name }}</span>
                                </div>
                                <div class="metric-discussion">
                                    {{ metric.discussion|linebreaks }}
                                </div>
                                {% if metric.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ metric.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in metric.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </section>

        <!-- Expert Analysis Grouped by Stance -->
        <section class="topic-section collapsible-section">
            <button class="stance-header" onclick="toggleSection(this)">
                <h3 class="section-title">Expert
                    Analysis ({{ total_experts_count }})</h3>
                <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="m6 9 6 6 6-6" />
                </svg>
            </button>
            <div class="stance-content">

                {% if hawkish_experts %}
                <div class="stance-group hawk collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Hawkish Opinions ({{ hawkish_experts|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="expert-list">
                            {% for expert in hawkish_experts %}
                            <div class="expert-card card">
                                <div class="expert-header">
                                    <div class="expert-info">
                                        <span class="expert-name">{{ expert.expert_name }}</span>
                                        <span class="expert-org text-muted">{{ expert.organization }}</span>
                                    </div>
                                </div>
                                <div class="expert-opinion">
                                    {{ expert.opinion|linebreaks }}
                                </div>
                                {% if expert.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ expert.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in expert.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if neutral_experts %}
                <div class="stance-group neutral collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Neutral Opinions ({{ neutral_experts|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="expert-list">
                            {% for expert in neutral_experts %}
                            <div class="expert-card card">
                                <div class="expert-header">
                                    <div class="expert-info">
                                        <span class="expert-name">{{ expert.expert_name }}</span>
                                        <span class="expert-org text-muted">{{ expert.organization }}</span>
                                    </div>
                                </div>
                                <div class="expert-opinion">
                                    {{ expert.opinion|linebreaks }}
                                </div>
                                {% if expert.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ expert.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in expert.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if dovish_experts %}
                <div class="stance-group dove collapsible-section">
                    <button class="stance-header" onclick="toggleSection(this)">
                        <h4 class="stance-label">Dovish Opinions ({{ dovish_experts|length }})</h4>
                        <svg class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6" />
                        </svg>
                    </button>
                    <div class="stance-content">
                        <div class="expert-list">
                            {% for expert in dovish_experts %}
                            <div class="expert-card card">
                                <div class="expert-header">
                                    <div class="expert-info">
                                        <span class="expert-name">{{ expert.expert_name }}</span>
                                        <span class="expert-org text-muted">{{ expert.organization }}</span>
                                    </div>
                                </div>
                                <div class="expert-opinion">
                                    {{ expert.opinion|linebreaks }}
                                </div>
                                {% if expert.citations.all %}
                                <details class="sources-toggle">
                                    <summary class="sources-label">View Sources ({{ expert.citations.count }})</summary>
                                    <div class="sources-list">
                                        {% for citation in expert.citations.all %}
                                        {% for source in citation.sources.all %}
                                        <div class="source-item">
                                            <blockquote class="source-quote">"{{ source.sentence }}"</blockquote>
                                            <div class="source-meta" style="flex-direction: column; align-items: flex-start;">
                                                <span class="source-title">{{ source.article_source }}</span>
                                                {% if source.article_url %}
                                                <a href="{{ source.article_url }}" target="_blank" rel="noopener"
                                                    class="full-article-link">Full Article →</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                </details>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/topic_detail.js' %}"></script>
{% endblock %}