{% extends "base.html" %}
{% load static %}

{% block title %}Report Box - Fed Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/report_box.css' %}">
{% endblock %}

{% block content %}
<div class="report-box-page animate-fade-in">

    <header class="page-header">
        <h1>Report Box</h1>
        <p class="text-muted">All generated reports from the multi-agent pipelines, sorted by date. Click a row to view
            details.</p>
        {% if next_run %}
        <div class="next-update-info"
            style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-clock">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span style="font-weight: 500;">Next Scheduled Update:</span>
            <span>{{ next_run|date:"M d, Y H:i" }} UTC</span>
        </div>
        {% endif %}
    </header>

    <!-- Filter Toolbar -->
    <div class="filter-toolbar card">
        <form method="get" class="filter-form">

            <div class="filter-group">
                <label for="type-filter" class="filter-label">Type</label>
                <select name="type" id="type-filter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="summary" {% if request.GET.type == 'summary' %}selected{% endif %}>Summary</option>
                    <option value="analysis" {% if request.GET.type == 'analysis' %}selected{% endif %}>Analysis</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="focus-filter" class="filter-label">Timing Focus</label>
                <select name="focus" id="focus-filter" class="filter-select">
                    <option value="">All Scenarios</option>
                    <option value="pre" {% if request.GET.focus == 'pre' %}selected{% endif %}>Pre-Announcement</option>
                    <option value="post" {% if request.GET.focus == 'post' %}selected{% endif %}>Post-Announcement
                    </option>
                    <option value="general" {% if request.GET.focus == 'general' %}selected{% endif %}>General</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="date-filter" class="filter-label">FOMC Date</label>
                <select name="fomc_date" id="date-filter" class="filter-select">
                    <option value="">All Dates</option>
                    {% for date in fomc_dates %}
                    <option value="{{ date|date:'Y-m-d' }}" {% if request.GET.fomc_date == date|date:'Y-m-d' %}selected{% endif %}>
                        {{ date|date:"M d, Y" }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{% url 'multi_agent_systems:report_box' %}" class="btn btn-outline">Reset</a>
            </div>

        </form>
    </div>

    <div class="table-wrapper card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Focus</th>
                    <th>FOMC Date</th>
                    <th>Delta</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr class="clickable-row" {% if report.report_type == "summary" %}
                    data-href="{% url 'multi_agent_systems:summary_detail' uuid=report.uuid %}" {% else %}
                    data-href="{% url 'multi_agent_systems:topic_analysis_detail' uuid=report.uuid %}" {% endif %}>
                    <td class="date-cell">{{ report.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        {% if report.report_type == "summary" %}
                        <span class="type-badge type-summary">Summary</span>
                        {% else %}
                        <span class="type-badge type-analysis">Analysis</span>
                        {% endif %}
                    </td>
                    <td>
                        <span
                            class="focus-badge {% if 'post' in report.get_timing_focus|lower %}focus-post{% elif 'pre' in report.get_timing_focus|lower %}focus-pre{% else %}focus-announcement{% endif %}">
                            {{ report.get_timing_focus }}
                        </span>
                    </td>
                    <td>
                        {% if report.fomc_announcement_datetime %}
                        {{ report.fomc_announcement_datetime|date:"Y-m-d" }}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ report.get_timing_delta|default:"-" }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="empty-row">No reports generated yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    {% if page_obj.has_other_pages %}
    <div class="pagination" style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline" style="min-width: 100px;">&larr;
            Previous</a>
        {% else %}
        <span class="btn btn-outline disabled" style="opacity: 0.5; cursor: default; min-width: 100px;">&larr;
            Previous</span>
        {% endif %}

        <span class="current-page"
            style="display: flex; align-items: center; font-weight: 600; color: var(--text-muted);">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline" style="min-width: 100px;">Next
            &rarr;</a>
        {% else %}
        <span class="btn btn-outline disabled" style="opacity: 0.5; cursor: default; min-width: 100px;">Next
            &rarr;</span>
        {% endif %}
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/report_box.js' %}"></script>
{% endblock %}