{% extends "base.html" %}
{% load static %}

{% block title %}Summary - {{ summary.uuid|stringformat:".8s" }} - Fed Intelligence{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/summary_detail.css' %}">
{% endblock %}

{% block content %}
<div class="summary-layout">

    <!-- Left Sidebar -->
    <aside class="summary-sidebar">
        <div class="sidebar-section">
            <h4>Report Info</h4>
            {% if summary.fomc_announcement_datetime %}
            <div class="info-item">
                <span class="info-label">FOMC</span>
                <span class="info-value">{{ summary.fomc_announcement_datetime|date:"F j, Y" }}</span>
            </div>
            {% endif %}
            <div class="info-item">
                <span class="info-label">Focus</span>
                <span class="info-value">{{ timing_focus }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Generated</span>
                <span class="info-value">{{ summary.created_at|date:"F j, Y, H:i" }}</span>
            </div>
            {% if timing_delta %}
            <div class="info-item">
                <span class="info-label">Delta</span>
                <span class="info-value delta-{% if 'post' in timing_focus|lower %}post{% else %}pre{% endif %}">{{ timing_delta }}</span>
            </div>
            {% endif %}
            <div class="info-item">
                <span class="info-label">Articles</span>
                <span class="info-value">{{ summary.article_count }}</span>
            </div>
        </div>

        <div class="sidebar-section">
            <h4>Navigation</h4>
            <div class="sidebar-nav-v">
                <a href="{% url 'multi_agent_systems:report_box' %}" class="btn btn-outline btn-full"> Report Box</a>

                <div class="nav-sequential">
                    {% if prev_summary %}
                    <a href="{% url 'multi_agent_systems:summary_detail' uuid=prev_summary.uuid %}" class="nav-mini-btn"
                        title="Previous Summary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        Prev
                    </a>
                    {% else %}
                    <span class="nav-mini-btn disabled">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        Prev
                    </span>
                    {% endif %}

                    {% if next_summary %}
                    <a href="{% url 'multi_agent_systems:summary_detail' uuid=next_summary.uuid %}" class="nav-mini-btn"
                        title="Next Summary">
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </a>
                    {% else %}
                    <span class="nav-mini-btn disabled">
                        Next
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="m9 18 6-6-6-6" />
                        </svg>
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if not next_summary %}
        <div class="sidebar-section next-update-sidebar">
            <h4>Scheduled</h4>
            <div class="info-item">
                <span class="info-label">Next</span>
                <span class="info-value">
                    {% if next_run %}
                    {{ next_run|date:"M j, H:i" }}
                    {% else %}
                    Daily at 8:00 AM
                    {% endif %}
                </span>
            </div>
        </div>
        {% endif %}
    </aside>

    <!-- Main Content -->
    <main class="summary-main animate-fade-in">
        <article class="summary-content card">
            <header class="summary-header">
                <h1>Daily News Summary</h1>
                <p class="subtitle text-muted">Click on any sentence to view its supporting sources</p>
            </header>

            <div class="summary-text">
                {% for citation in summary.citations.all %}<span
                    class="citable-sentence {% if citation.sources.count > 0 %}has-sources{% endif %}"
                    data-citation-id="{{ citation.id }}">{{ citation.summary_sentence }}</span> {% empty %}{{
                summary.summary_text|linebreaks }}{% endfor %}
            </div>
        </article>
    </main>

    <!-- Right Sidebar for Citations -->
    <aside class="citation-sidebar" id="citationPanel">
        <div class="citation-header">
            <h4>Supporting Sources</h4>
            <button class="close-btn" id="closeCitations">&times;</button>
        </div>
        <div class="citation-content" id="citationContent">
            <p class="placeholder-text">Select a sentence to view its sources.</p>
        </div>
    </aside>

</div>

<!-- Citation data as JSON for JavaScript -->
<script type="application/json" id="citationData">
{
    {% for citation in summary.citations.all %}
    "{{ citation.id }}": {
        "sentence": "{{ citation.summary_sentence|escapejs }}",
        "sources": [
            {% for source in citation.sources.all %}
            {
                "sentence": "{{ source.sentence|escapejs }}",
                "article_title": "{{ source.article_title|escapejs }}",
                "article_source": "{{ source.article_source|escapejs }}",
                "article_url": "{{ source.article_url|escapejs }}",
                "expert_name": "{{ source.expert_name|default:''|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/summary_detail.js' %}"></script>
{% endblock %}